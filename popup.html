<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Copilot Indexer</title>
    <link rel="stylesheet" href="popup.css" />
  </head>
  <body>
    <header class="toolbar">
      <div class="toolbar__title">Copilot Chat Indexer</div>
      <div class="toolbar__actions">
        <button id="clearCacheBtn" class="toolbar__action-btn" title="Очистить кэш индекса (⚠️ Индекс будет перезагружен из БД при следующем поиске)">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M2 2L14 14M14 2L2 14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            <circle cx="8" cy="8" r="6" stroke="currentColor" stroke-width="1.5" fill="none"/>
          </svg>
        </button>
        <button id="refreshExtensionBtn" class="toolbar__refresh-btn" title="Перезагрузить расширение">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="8" cy="8" r="5.5" stroke="currentColor" stroke-width="1.5" fill="none"/>
            <path d="M11 5L13.5 2.5L13.5 5.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M5 11L2.5 13.5L2.5 10.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </header>
    <div id="status" class="status hidden"></div>

    <!-- Tabs -->
    <div class="tabs">
      <button id="tabIndex" class="tab-button active" data-tab="index">Индекс</button>
      <button id="tabSearch" class="tab-button" data-tab="search">Поиск</button>
      <button id="tabRequests" class="tab-button" data-tab="requests">Запросы</button>
    </div>

    <!-- Index Tab -->
    <div id="tabContentIndex" class="tab-content active">
      <div class="index-section">
        <button id="diagnosticsBtn" class="action-button">Проверить состояние</button>
        
        <!-- Collapsible Indexing Section -->
        <div class="indexing-section">
          <div class="indexing-header">
            <button id="indexToggleBtn" class="index-toggle-button">
              <span class="toggle-icon">▼</span>
              <span>Индексация</span>
              <span id="indexingStats" class="indexing-stats"></span>
            </button>
            <div id="indexingInfo" class="indexing-info hidden"></div>
            <button id="indexControlBtn" class="index-control-button">Начать индексацию</button>
          </div>
          <div id="indexingContent" class="indexing-content collapsed">
            <!-- Chat Selection -->
            <div id="chatSelectionContainer" class="chat-selection-container">
              <div class="chat-selection-header">
                <label class="select-all-checkbox">
                  <input type="checkbox" id="selectAllChats" />
                  <span>Выбрать все</span>
                </label>
                <div class="sort-controls">
                  <select id="sortBy" class="sort-select">
                    <option value="date-desc">По дате (позднее)</option>
                    <option value="date-asc">По дате (раньше)</option>
                    <option value="checked">Чекнутые</option>
                    <option value="unchecked">Анчекнутые</option>
                    <option value="alphabet">По алфавиту</option>
                  </select>
                </div>
              </div>
              <div id="chatsList" class="chats-list">
                <div class="loading-chats">Загрузка чатов...</div>
              </div>
            </div>
            
            <button id="resumeIndexBtn" class="action-button" style="display: none;">Возобновить индексацию</button>
          </div>
        </div>
        
        <!-- Markdown Export Section -->
        <div class="indexing-section">
          <div class="indexing-header">
            <button id="mdExportToggleBtn" class="index-toggle-button">
              <span class="toggle-icon">▼</span>
              <span>Экспорт в .md</span>
              <span id="mdExportStats" class="indexing-stats"></span>
            </button>
            <div id="mdExportInfo" class="indexing-info hidden"></div>
            <button id="mdExportControlBtn" class="index-control-button">Начать экспорт</button>
          </div>
          <div id="mdExportContent" class="indexing-content collapsed">
            <!-- Chat Selection for Markdown Export -->
            <div id="mdChatSelectionContainer" class="chat-selection-container">
              <div class="chat-selection-header">
                <label class="select-all-checkbox">
                  <input type="checkbox" id="selectAllMdChats" />
                  <span>Выбрать все</span>
                </label>
                <div class="sort-controls">
                  <select id="mdSortBy" class="sort-select">
                    <option value="date-desc">По дате (позднее)</option>
                    <option value="date-asc">По дате (раньше)</option>
                    <option value="checked">Чекнутые</option>
                    <option value="unchecked">Анчекнутые</option>
                    <option value="alphabet">По алфавиту</option>
                  </select>
                </div>
              </div>
              <div id="mdChatsList" class="chats-list">
                <div class="loading-chats">Загрузка чатов...</div>
              </div>
            </div>
          </div>
        </div>
        
        <button id="exportBtn" class="action-button">Сохранить базу</button>
        <button id="importBtn" class="action-button">Загрузить базу</button>
        <input type="file" id="importFile" accept=".json,.zip" multiple style="display: none;" />
        <button id="resetBtn" class="action-button danger">Сбросить базу</button>
        <div id="indexProgress" class="progress hidden"></div>
        <div id="diagnosticsInfo" class="diagnostics-info hidden"></div>
      </div>
    </div>

    <!-- Search Tab -->
    <div id="tabContentSearch" class="tab-content">
      <div class="search-section">
        <div class="search-input-wrapper">
          <input type="text" id="searchInput" class="search-input" placeholder="Введите минимум 2 символа для поиска..." autocomplete="off" />
          <button id="searchClearBtn" class="search-clear-btn hidden" title="Очистить поиск" aria-label="Очистить поиск">×</button>
          <div id="searchHistoryDropdown" class="search-history-dropdown hidden"></div>
        </div>
        <div id="searchResults" class="search-results"></div>
        <div id="searchEmpty" class="empty">Введите запрос для поиска</div>
      </div>
    </div>

    <!-- Requests Tab -->
    <div id="tabContentRequests" class="tab-content">
      <div class="requests-section">
        <div class="requests-header">
          <button id="refreshRequestsBtn" class="action-button">Обновить</button>
          <button id="clearRequestsBtn" class="action-button">Очистить</button>
          <span id="requestsCount" class="requests-count"></span>
        </div>
        <div id="requestsList" class="requests-list"></div>
        <div id="requestsEmpty" class="empty">Нет запросов. Откройте страницу Copilot и обновите список.</div>
        <div id="responseViewer" class="response-viewer hidden">
          <div class="response-viewer-header">
            <span id="responseViewerTitle" class="response-viewer-title"></span>
            <button id="closeResponseViewer" class="close-button">×</button>
          </div>
          <div id="responseViewerContent" class="response-viewer-content"></div>
        </div>
      </div>
    </div>

    <!-- Merge Dialog Modal -->
    <div id="mergeDialog" class="modal-overlay hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Объединение баз данных</h3>
        </div>
        <div class="modal-body">
          <p class="modal-warning">
            В базе данных уже есть данные. Загружаемая база будет объединена с существующей.
          </p>
          <p id="conflictInfo" class="modal-conflict-info"></p>
          <p class="modal-question">
            При обнаружении пересечений (чаты с одинаковыми ID):
          </p>
          <div class="modal-options">
            <label class="modal-option">
              <input type="radio" name="mergeStrategy" value="keep_current" checked />
              <span class="modal-option-label">
                <strong>Оставить текущие версии</strong>
                <span class="modal-option-desc">Текущие данные останутся без изменений</span>
              </span>
            </label>
            <label class="modal-option">
              <input type="radio" name="mergeStrategy" value="keep_imported" />
              <span class="modal-option-label">
                <strong>Использовать загружаемые версии</strong>
                <span class="modal-option-desc">Загружаемые данные заменят текущие</span>
              </span>
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button id="mergeDialogCancel" class="action-button">Отмена</button>
          <button id="mergeDialogConfirm" class="action-button">Продолжить</button>
        </div>
      </div>
    </div>

    <!-- Export Options Dialog Modal -->
    <div id="exportOptionsDialog" class="modal-overlay hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Выберите способ сохранения</h3>
        </div>
        <div class="modal-body">
          <div class="modal-options">
            <label class="modal-option">
              <input type="radio" name="exportStrategy" value="single" checked />
              <span class="modal-option-label">
                <strong>Сохранить одним файлом</strong>
                <span class="modal-option-desc">Все данные будут сохранены в один файл</span>
              </span>
            </label>
            <label class="modal-option modal-option-disabled">
              <input type="radio" name="exportStrategy" value="by_month" disabled />
              <span class="modal-option-label">
                <strong>По месяцам</strong>
                <span class="modal-option-desc">Данные будут разделены по месяцам и сохранены в ZIP архив</span>
              </span>
            </label>
            <label class="modal-option">
              <input type="radio" name="exportStrategy" value="by_parts" />
              <span class="modal-option-label">
                <strong>На несколько частей</strong>
                <span class="modal-option-desc">Данные будут разделены на указанное количество частей и сохранены в ZIP архив</span>
              </span>
            </label>
          </div>
          <div id="partsInputContainer" class="modal-input-container hidden" style="margin-top: 16px;">
            <label for="partsCountInput" style="display: block; margin-bottom: 8px; font-size: 13px; color: #333; font-weight: 500;">
              Количество частей:
            </label>
            <input type="number" id="partsCountInput" min="2" max="100" value="2" 
                   style="width: 100%; padding: 8px; border: 1px solid #c7c7c7; border-radius: 4px; font-size: 13px;" />
          </div>
        </div>
        <div class="modal-footer">
          <button id="exportOptionsCancel" class="action-button">Отмена</button>
          <button id="exportOptionsConfirm" class="action-button">Сохранить</button>
        </div>
      </div>
    </div>

    <script src="lib/jszip.min.js"></script>
    <script src="popup.js"></script>
  </body>
</html>



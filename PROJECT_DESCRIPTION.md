# Описание проекта: Copilot Chat Indexer

## Общая информация

**Тип проекта:** Chrome Extension (Manifest V3)  
**Название:** Copilot Chat Indexer  
**Версия:** 1.1.2  
**Назначение:** Локальная индексация и полнотекстовый поиск по чатам Microsoft Copilot

## Структура проекта

```
copilot_addon01/
├── manifest.json              # Манифест расширения Chrome
├── background.js              # Service Worker (мониторинг запросов, индексация)
├── content.js                 # Content Script (извлечение данных со страницы)
├── popup.html                 # HTML интерфейса расширения
├── popup.js                   # Логика интерфейса
├── popup.css                  # Стили интерфейса
├── storage/
│   ├── db.js                  # Модуль работы с IndexedDB
│   └── indexer.js             # Модуль работы с FlexSearch индексами
├── lib/
│   ├── flexsearch-loader.js   # Загрузчик библиотеки FlexSearch
│   └── jszip.min.js           # Библиотека JSZip (минифицированная)
├── .gitignore                 # Игнорируемые файлы
└── README.md                  # Документация проекта
```

## Технологический стек

- **Chrome Extensions API** (Manifest V3)
- **IndexedDB** - хранение данных локально
- **FlexSearch 0.7.43** - полнотекстовый поиск (загружается с CDN)
- **JSZip** - работа с ZIP архивами для экспорта/импорта
- **Vanilla JavaScript** (ES6+)

## Основной функционал

### 1. Мониторинг сетевых запросов
- Перехват запросов к API Copilot (`/c/api/conversations`)
- Сохранение истории запросов (до 500 на вкладку)
- Использование Chrome Debugger API для получения тел ответов
- Фильтрация только релевантных запросов

### 2. Извлечение данных
- Автоматическое определение email аккаунта из DOM
- Извлечение списка чатов из API ответов
- Парсинг сообщений пользователя и ассистента со страницы
- Очистка HTML от UI элементов, эмодзи, нормализация текста

### 3. Индексация
- Индексация чатов и сообщений в IndexedDB
- Создание полнотекстовых индексов через FlexSearch
- Поддержка кириллицы и латиницы
- Инкрементальная индексация (только новые/обновленные чаты)
- Поддержка нескольких аккаунтов

### 4. Поиск
- Полнотекстовый поиск по всем индексированным чатам
- Минимум 2 символа для поиска
- Подсветка найденных фрагментов
- Группировка результатов по чатам
- Отображение контекста найденных сообщений

### 5. Управление данными
- Экспорт базы данных (JSON или ZIP с разделением по месяцам/частям)
- Импорт базы данных с объединением (merge strategy)
- Сброс базы данных
- Диагностика состояния базы

## Детальное описание файлов

### manifest.json
```json
{
  "manifest_version": 3,
  "name": "Copilot Chat Indexer",
  "version": "1.1.2",
  "description": "Local indexing and search for Microsoft Copilot chats",
  "permissions": ["tabs", "webRequest", "storage", "debugger", "windows", "scripting", "downloads"],
  "host_permissions": ["*://copilot.microsoft.com/*"],
  "background": {
    "service_worker": "background.js"
  },
  "action": {
    "default_popup": "popup.html",
    "default_title": "Copilot Indexer"
  },
  "content_scripts": [{
    "matches": ["*://copilot.microsoft.com/*"],
    "js": ["content.js"],
    "run_at": "document_idle"
  }],
  "web_accessible_resources": [{
    "resources": ["storage/*", "lib/*"],
    "matches": ["*://copilot.microsoft.com/*"]
  }]
}
```

### background.js
**Основные функции:**
- `shouldStoreRequest(url)` - проверка, нужно ли сохранять запрос
- `ensureDebuggerAttached(tabId)` - подключение debugger для перехвата ответов
- `storeRequest()` - сохранение сетевых запросов
- Обработка сообщений от popup/content scripts
- Индексация чатов (последовательная обработка выбранных чатов)
- Управление состоянием индексации (старт/стоп/пауза)

**Ключевые особенности:**
- Использует Chrome Debugger API для получения тел ответов
- Отслеживает активные вкладки с Copilot
- Ограничивает количество сохраняемых запросов (MAX_REQUESTS = 500)
- Блокирует сохранение новых запросов во время активной индексации

### content.js
**Основные функции:**
- `findEmailInDOM()` - поиск email аккаунта в DOM (4 стратегии)
- `extractChatMessages()` - извлечение сообщений из чата
- `convertHtmlToPlainText(html)` - конвертация HTML в чистый текст
- `splitIntoSentences(text)` - разбиение текста на предложения

**Обработчики сообщений:**
- `getAccountInfo` - получение информации об аккаунте
- `checkContentReady` - проверка готовности контента к индексации
- `checkContentReadyAndGet` - объединенная проверка и получение
- `getChatContent` - извлечение контента чата
- `clickAccountButton` - клик по кнопке аккаунта для открытия попапа

### popup.html
**Структура интерфейса:**
- Заголовок с названием расширения
- Три вкладки: Индекс, Поиск, Запросы
- Модальные окна для объединения баз и выбора экспорта

**Вкладка "Индекс":**
- Кнопка "Проверить состояние"
- Секция индексации (сворачиваемая):
  - Список чатов с чекбоксами
  - Сортировка (по дате, алфавиту, статусу)
  - Кнопка "Начать индексацию"
- Кнопки: Сохранить базу, Загрузить базу, Сбросить базу

**Вкладка "Поиск":**
- Поле ввода поискового запроса
- Список результатов с подсветкой совпадений
- Возможность свернуть/развернуть чаты

**Вкладка "Запросы":**
- Список перехваченных сетевых запросов
- Детальный просмотр запроса/ответа
- Фильтрация по статусу

### popup.js
**Основные функции:**
- Управление вкладками
- Загрузка списка чатов из IndexedDB
- Управление выбором чатов для индексации
- Запуск/остановка индексации
- Поиск по индексу
- Экспорт/импорт базы данных
- Отображение сетевых запросов

**Ключевые переменные:**
- `currentAccountEmail` - текущий email аккаунта
- `chatsData` - массив данных о чатах
- `selectedChatIds` - Set выбранных чатов
- `chatCheckboxes` - Map чекбоксов чатов

### storage/db.js
**IndexedDB структура:**
- **accounts** - аккаунты (key: email)
  - Индексы: createdAtUTC
- **chats** - чаты (key: chatId)
  - Индексы: accountEmail, updatedAtUTC, lastIndexedUTC
- **messages** - сообщения (key: id)
  - Индексы: chatId, timestampUTC
- **indexes** - сериализованные FlexSearch индексы (key: accountEmail)

**Основные функции:**
- `initDB()` - инициализация базы данных
- `upsertAccount()` - создание/обновление аккаунта
- `upsertChat()` - создание/обновление чата
- `upsertMessage()` - создание/обновление сообщения
- `getChatsByAccount()` - получение чатов аккаунта
- `getChatsToIndex()` - получение чатов для индексации
- `saveIndex()` / `getIndex()` - работа с FlexSearch индексами
- `resetAccountData()` - сброс данных аккаунта

### storage/indexer.js
**Основные функции:**
- `loadFlexSearchLib()` - загрузка FlexSearch с CDN
- `createIndex()` - создание нового индекса
- `getIndex()` - получение индекса (из кэша или IndexedDB)
- `addToIndex()` - добавление документов в индекс
- `updateIndex()` - обновление документов в индексе
- `removeFromIndex()` - удаление документов из индекса
- `search()` - поиск по индексу
- `serializeIndex()` / `deserializeIndex()` - сериализация индекса

**Настройки FlexSearch:**
- Preset: 'default'
- Tokenize: 'forward'
- Cache: 100
- Context: resolution 9, depth 2, bidirectional
- Поддержка кириллицы и латиницы

### popup.css
**Основные стили:**
- Размер popup: 420x600px
- Три вкладки с переключением
- Стили для списков чатов, результатов поиска, запросов
- Модальные окна для диалогов
- Адаптивная верстка с flexbox
- Кастомные скроллбары

## Процесс индексации

1. **Получение списка чатов:**
   - Извлечение из перехваченных API запросов
   - Сохранение в IndexedDB (таблица `chats`)

2. **Выбор чатов:**
   - Пользователь выбирает чаты через UI
   - Можно выбрать все или отдельные чаты
   - Сортировка по дате, алфавиту, статусу

3. **Обработка чата:**
   - Открытие вкладки с чатом (если не открыт)
   - Ожидание загрузки контента
   - Извлечение сообщений через content script
   - Сохранение сообщений в IndexedDB
   - Добавление в FlexSearch индекс

4. **Сохранение индекса:**
   - Сериализация FlexSearch индекса
   - Сохранение в IndexedDB (таблица `indexes`)
   - Обновление метаданных чата (lastIndexedUTC)

## Процесс поиска

1. **Ввод запроса:**
   - Минимум 2 символа
   - Поиск выполняется с задержкой (debounce)

2. **Поиск в индексе:**
   - Загрузка FlexSearch индекса для аккаунта
   - Выполнение поиска
   - Получение ID найденных документов

3. **Получение данных:**
   - Загрузка сообщений по ID из IndexedDB
   - Группировка по чатам
   - Подсветка совпадений

4. **Отображение результатов:**
   - Список чатов с найденными сообщениями
   - Подсветка найденных фрагментов
   - Возможность свернуть/развернуть чаты

## Экспорт/импорт

### Экспорт
- **Одним файлом:** весь JSON
- **По месяцам:** разделение на файлы по месяцам, упаковка в ZIP
- **На части:** разделение на N частей, упаковка в ZIP

### Импорт
- Загрузка JSON или ZIP файлов
- Определение конфликтов (чаты с одинаковыми ID)
- Выбор стратегии объединения:
  - Оставить текущие версии
  - Использовать загружаемые версии

## Разрешения расширения

- `tabs` - доступ к информации о вкладках
- `webRequest` - мониторинг сетевых запросов
- `storage` - локальное хранилище
- `debugger` - перехват тел ответов
- `windows` - информация об окнах
- `scripting` - выполнение скриптов
- `downloads` - сохранение экспортированных файлов
- `host_permissions` - доступ к copilot.microsoft.com

## Зависимости

### Внешние библиотеки (загружаются с CDN):
- **FlexSearch 0.7.43** - `https://cdn.jsdelivr.net/npm/flexsearch@0.7.43/dist/flexsearch.min.js`
- **JSZip** - включена локально (`lib/jszip.min.js`)

## Особенности реализации

1. **Асинхронная индексация:**
   - Последовательная обработка чатов
   - Возможность паузы/возобновления
   - Прогресс индексации

2. **Множественные аккаунты:**
   - Разделение данных по email
   - Отдельные индексы для каждого аккаунта
   - Автоматическое определение текущего аккаунта

3. **Оптимизация памяти:**
   - Ограничение количества сохраняемых запросов
   - Кэширование индексов в памяти
   - Сериализация индексов для долгосрочного хранения

4. **Обработка ошибок:**
   - Graceful degradation при недоступности API
   - Retry логика для загрузки библиотек
   - Валидация данных перед сохранением

## Установка и запуск

1. Клонировать репозиторий
2. Открыть Chrome → `chrome://extensions/`
3. Включить "Режим разработчика"
4. Нажать "Загрузить распакованное расширение"
5. Выбрать папку проекта

## Использование

1. Открыть Microsoft Copilot в браузере
2. Кликнуть на иконку расширения
3. Во вкладке "Индекс" выбрать чаты и начать индексацию
4. Во вкладке "Поиск" выполнять поиск по индексированным чатам
5. Во вкладке "Запросы" просматривать перехваченные API запросы

## Примечания

- Расширение работает только на `copilot.microsoft.com`
- Требуется активная вкладка с Copilot для извлечения данных
- Индексация выполняется последовательно для каждого чата
- FlexSearch загружается динамически с CDN при первом использовании
- Все данные хранятся локально в IndexedDB браузера
